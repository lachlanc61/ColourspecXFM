#to build clean from dockerhub
BootStrap: docker
From: python:3.10.6  

#local cached
#BootStrap: localimage
#From: /home/lachlan/SIFSTORE/python_3.10.6.sif

%files
#   apptainer doesn't seem to have an equivalent to .dockerignore 
#   need to list everything explicitly to avoid unwanted data in the container
    ../xfmparser /app/xfmparser
    ../xfmreadout /app/xfmreadout
    ../tests /app/tests    
    ../data/example_datafile.GeoPIXE /app/data/example_datafile.GeoPIXE
    ../pyproject.toml /app/
    ../setup.cfg /app/
    ../README.md /app/

%post
    apt-get update && apt-get -y install \
        git \
        vim
    pip install --upgrade pip

    #manually pre-install pybind11 (needed for for C++ submodule to connect properly)
    python -m pip install pybind11==2.10.4
    #python -m pip install -r /app/xfmparser/requirements.txt
    
    #install main package
    pip install -e /app

#%test
#not working, needs to be able to write to /app folder
#    cd /app
#    pytest

%runscript
    #echo "This is what happens when you run the container..."
    echo "Arguments received: $*"
    exec xfmread-raw "$@"
    exec echo "$@"
    


